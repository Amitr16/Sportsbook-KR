# GoalServe Sports Betting Platform - Deployment Setup

## ğŸš€ Deployment Architecture

### Current Setup
- **Frontend**: Cloudflare Pages (HTML/JS/CSS)
- **Backend**: Fly.io (Flask API + Database)
- **Domain**: Custom domain with subdomain routing

### Recommended Setup
- **Frontend**: Cloudflare Pages (Static files)
- **Backend**: Fly.io (Flask API + Database)
- **Routing**: Cloudflare Pages handles frontend, proxies API calls to Fly.io

## ğŸ“ Route Classification

### Frontend-Only Routes (Cloudflare Pages)
These routes serve static HTML/JS/CSS files and should be handled by Cloudflare Pages:

```
/register-sportsbook          â†’ register-sportsbook.html
/admin-login                  â†’ admin-login.html
/superadmin                   â†’ superadmin-login.html (rendered by Flask)
/<subdomain>                  â†’ index.html (dynamically branded)
/<subdomain>/admin            â†’ admin-dashboard.html
```

### API Routes (Fly.io Backend)
These routes handle data processing and should be proxied to Fly.io:

```
/api/register-sportsbook      â†’ POST: Sportsbook registration
/api/admin-login              â†’ POST: Admin authentication
/api/superadmin/login         â†’ POST: Superadmin authentication
/api/auth/<subdomain>/login   â†’ POST: Customer authentication
/api/auth/<subdomain>/profile â†’ GET: User profile validation
/api/theme-css/<subdomain>    â†’ GET: Dynamic CSS generation
/api/betting/*                â†’ Betting operations
/api/sports/*                 â†’ Sports data
```

### Dynamic Routes (Flask Rendered)
These routes are generated by Flask and should be handled by Fly.io:

```
/<subdomain>/login            â†’ Customer login page (rendered)
/<subdomain>/games            â†’ Games page (rendered)
```

## ğŸ”§ Cloudflare Pages Configuration

### `_redirects` File
Create this file in your Cloudflare Pages project root:

```plaintext
# Frontend routes - serve static files
/register-sportsbook    /register-sportsbook.html   200
/admin-login            /admin-login.html           200
/superadmin             /superadmin-login.html      200

# API routes - proxy to Fly.io backend
/api/*                  https://your-app.fly.dev/api/:splat    200

# Dynamic routes - proxy to Fly.io backend
/*/login                https://your-app.fly.dev/:splat        200
/*/admin                https://your-app.fly.dev/:splat        200
/*/games                https://your-app.fly.dev/:splat        200

# Subdomain routes - proxy to Fly.io backend
/*                      https://your-app.fly.dev/:splat        200

# Fallback for SPA routing
/*                      /index.html                 200
```

### `wrangler.toml` Configuration
```toml
name = "goalserve-sportsbook"
compatibility_date = "2024-01-01"

[env.production]
name = "goalserve-sportsbook"
route = "yourdomain.com/*"

[env.production.vars]
BACKEND_URL = "https://your-app.fly.dev"

[[env.production.rules]]
type = "ESModule"
globs = ["**/*.js"]

[env.production.redirects]
# API routes
"/api/*" = "https://your-app.fly.dev/api/:splat"
# Dynamic routes
"/*/login" = "https://your-app.fly.dev/:splat"
"/*/admin" = "https://your-app.fly.dev/:splat"
"/*/games" = "https://your-app.fly.dev/:splat"
# Subdomain routes
"/*" = "https://your-app.fly.dev/:splat"
```

## ğŸ› Common Deployment Issues

### 1. CORS Errors
**Issue**: Frontend can't call backend API
**Solution**: Ensure Fly.io backend has proper CORS configuration

```python
# In your Flask app
from flask_cors import CORS

app = Flask(__name__)
CORS(app, origins=["https://yourdomain.com", "https://*.yourdomain.com"])
```

### 2. Subdomain Routing Failures
**Issue**: `/demosportshub` routes don't work
**Solution**: Ensure Cloudflare Pages proxies subdomain routes to Fly.io

### 3. Static File Serving Issues
**Issue**: HTML/CSS/JS files not loading
**Solution**: Verify Cloudflare Pages serves static files correctly

### 4. API Proxy Failures
**Issue**: API calls return 404 or timeout
**Solution**: Check Fly.io app is running and accessible

## ğŸ” Testing Deployment

### Frontend Testing
1. **Static Files**: Verify HTML/CSS/JS load correctly
2. **Routing**: Test all frontend routes work
3. **Branding**: Check theme customization loads

### Backend Testing
1. **API Endpoints**: Test all API routes respond
2. **Database**: Verify database connections work
3. **Authentication**: Test login/registration flows

### Integration Testing
1. **End-to-End Flows**: Test complete user journeys
2. **Cross-Origin**: Verify frontend-backend communication
3. **Performance**: Check response times and loading

## ğŸ“‹ Deployment Checklist

### Cloudflare Pages
- [ ] Static files uploaded correctly
- [ ] `_redirects` file configured
- [ ] Custom domain configured
- [ ] Environment variables set

### Fly.io Backend
- [ ] App deployed and running
- [ ] Database accessible
- [ ] Environment variables configured
- [ ] CORS settings updated

### DNS Configuration
- [ ] Domain points to Cloudflare Pages
- [ ] Subdomains route correctly
- [ ] SSL certificates active

### Testing
- [ ] Frontend routes accessible
- [ ] API endpoints responding
- [ ] Authentication flows working
- [ ] Multi-tenant routing functional

## ğŸš¨ Troubleshooting Commands

### Check Fly.io Status
```bash
fly status
fly logs
fly ssh console
```

### Check Cloudflare Pages
```bash
# Deploy status
wrangler pages deployment list

# View logs
wrangler pages deployment tail <deployment-id>
```

### Test API Endpoints
```bash
# Test backend directly
curl https://your-app.fly.dev/api/health

# Test through Cloudflare
curl https://yourdomain.com/api/health
```

## ğŸ”„ Deployment Workflow

### 1. Backend Deployment (Fly.io)
```bash
# Deploy backend changes
fly deploy

# Verify deployment
fly status
fly logs
```

### 2. Frontend Deployment (Cloudflare Pages)
```bash
# Build and deploy frontend
npm run build
wrangler pages publish dist

# Verify deployment
wrangler pages deployment list
```

### 3. Testing
```bash
# Test all routes
./test-deployment.sh

# Check for errors
wrangler pages deployment tail <latest-deployment>
```

This deployment setup ensures proper separation between frontend and backend while maintaining the multi-tenant architecture and subdomain routing.
